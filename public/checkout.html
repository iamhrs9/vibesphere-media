<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - VibeSphere</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f7fafc; padding: 40px 20px; display: flex; justify-content: center; }
        .checkout-box { background: white; width: 100%; max-width: 500px; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .summary { background: #F3E8FF; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid #6B46C1; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        label { font-weight: 600; color: #555; font-size: 14px; margin-top: 10px; display: block; }
        .btn-pay { width: 100%; margin-top: 20px; border:none; padding: 15px; font-size: 16px; border-radius: 6px; background: #6B46C1; color: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-pay:hover { background: #553C9A; }
        .btn-pay:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="checkout-box">
        <h2>Finalize Your Order</h2>
        
        <div class="summary">
            <h4 style="margin: 0 0 10px 0;">ðŸ“¦ Plan: <span id="dispPkg" style="color: #6B46C1;">Loading...</span></h4>
            <h4 style="margin: 0;">ðŸ’° Price: <span id="dispPrice">0</span></h4>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">Instagram: <span id="dispInsta">...</span></p>
        </div>

        <form id="orderForm">
            <label>Full Name</label>
            <input type="text" id="name" placeholder="Enter your name" required>

            <label>WhatsApp Number</label>
            <input type="tel" id="phone" placeholder="Your WhatsApp Number" required>

            <label>Email Address</label>
            <input type="email" id="email" placeholder="name@example.com" required>

            <button type="submit" class="btn-pay">Pay Now & Place Order</button>
        </form>
    </div>

   <script>
       // ==========================================
       // ðŸ’³ SMART CHECKOUT SYSTEM (Updated)
       // ==========================================

        // 1. URL SE DATA NIKALO
        const params = new URLSearchParams(window.location.search);
        
        const pkg = params.get('package');
        const price = params.get('price'); // e.g., "$19" or "640 NPR"
        const insta = params.get('insta');
        
        // Agar URL me currency hai toh wo lo, nahi toh INR default
        const currencyFromURL = params.get('currency') || "INR"; 

        // Screen par dikhao
        if(pkg) {
            document.getElementById('dispPkg').innerText = pkg;
            document.getElementById('dispPrice').innerText = price; 
            document.getElementById('dispInsta').innerText = insta || "Not Provided";
        }

        // 2. PAYMENT LOGIC
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            
            // Amount Clean Karo (sirf numbers bacha ke rakho)
            const rawPrice = document.getElementById('dispPrice').innerText;
            const finalAmount = parseFloat(rawPrice.replace(/[^0-9.]/g, ''));
            
            // Button Update
            const btn = document.querySelector('.btn-pay');
            btn.innerText = "Processing Payment...";
            btn.disabled = true;

            try {
                // Step A: Server ko Order Create karne bolo
                const orderResponse = await fetch('/api/create-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: finalAmount, 
                        currency: currencyFromURL // âœ… Ab sahi currency jayegi (USD/INR/NPR)
                    }) 
                });
                
                if (!orderResponse.ok) throw new Error("Server Error");
                const orderData = await orderResponse.json();

                // Step B: Razorpay Popup Open Karo
                const options = {
                    "key": "rzp_live_SBZ3O1RXMGtguq", // ðŸ”‘ APNI KEY CHECK KAR LENA
                    "amount": orderData.amount, // Server se aaya hua amount (paise me)
                    "currency": orderData.currency, // Server se aayi hui currency
                    "name": "VibeSphere Media",
                    "description": `Payment for ${pkg}`,
                    "order_id": orderData.id, // Razorpay Order ID
                    "handler": async function (response) {
                        
                        // Step C: Payment Success hone par Verify karo
                        const verifyResponse = await fetch('/api/verify-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_signature: response.razorpay_signature,
                                orderDetails: {
                                    package: pkg,
                                    price: rawPrice, // Display price (e.g. $19)
                                    currency: currencyFromURL,
                                    instaLink: insta,
                                    customerName: name,
                                    phone: phone,
                                    email: email
                                }
                            })
                        });

                        const result = await verifyResponse.json();
                        if(result.success) {
                            alert("Order Placed Successfully! ðŸŽ‰");
                            window.location.href = '/'; // Home page par bhej do
                        } else {
                            alert("Payment Verification Failed! Contact Support.");
                            btn.disabled = false;
                            btn.innerText = "Pay Now & Place Order";
                        }
                    },
                    "prefill": { "name": name, "email": email, "contact": phone },
                    "theme": { "color": "#6B46C1" }
                };

                const rzp1 = new Razorpay(options);
                
                rzp1.on('payment.failed', function (response){
                    alert("Payment Failed! Please try again.");
                    btn.disabled = false;
                    btn.innerText = "Pay Now & Place Order";
                });

                rzp1.open();

            } catch (error) {
                console.error(error);
                alert("Something went wrong. Check console.");
                btn.disabled = false;
                btn.innerText = "Pay Now & Place Order";
            }
        });
    </script>
</body>
</html>