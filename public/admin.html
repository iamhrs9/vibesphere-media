<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - VibeSphere</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://cdn.tiny.cloud/1/1w8pckp2kybf64f8g1fr4374ima09gr8xgr0ru01fecpzd0i/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        * { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f6f9; color: #333; }

        /* Login Modal */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #6c63ff; display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 350px; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; }
        .login-box button { width: 100%; padding: 12px; background: #222; color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* Dashboard */
        .dashboard { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #6c63ff; }
        .logout-btn { background: #ff4757; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #888; }
        .tab.active { color: #6c63ff; border-bottom: 3px solid #6c63ff; }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #6c63ff; color: white; }
        tr:hover { background: #f9f9f9; }

        /* Review Card Style inside Admin */
        .review-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        .delete-btn { background: #ff4757; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .delete-btn:hover { background: #ff6b81; }

        /* --- BLOG FORM STYLES --- */
        .blog-editor { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .form-group input:focus, .form-group textarea:focus { border-color: #6c63ff; outline: none; }
        
        .btn-publish { background: #6c63ff; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: 0.3s; }
        .btn-publish:hover { background: #5a52d5; transform: translateY(-2px); }
        
        .btn-cancel { background: #64748b; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; display: none; margin-left: 10px; }

        /* üü¢ Editor Style Fix */
        .tox-tinymce { border-radius: 8px !important; border: 1px solid #ddd !important; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Admin Login üîí</h2>
            <input type="password" id="adminPass" placeholder="Enter Admin Password">
            <button onclick="adminLogin()">Access Dashboard</button>
            <p id="errorMsg" style="color: red; margin-top: 10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>VibeSphere Admin</h1>
            <button onclick="logout()" class="logout-btn">Logout <i class="ri-logout-box-r-line"></i></button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('reviews', this)">User Reviews</div>
            <div class="tab" onclick="switchTab('orders', this)">Orders (Database)</div>
            <div class="tab" onclick="switchTab('blogs', this)">Write Blog ‚úçÔ∏è</div>
        </div>

        <div id="reviews" class="section active">
            <h3>Manage Reviews</h3>
            <table>
                <thead>
                    <tr><th>Date</th><th>User</th><th>Rating</th><th>Message</th><th>Action</th></tr>
                </thead>
                <tbody id="reviewsTable"></tbody>
            </table>
        </div>

        <div id="orders" class="section">
            <h3>Recent Orders</h3>
            <table>
                <thead>
                    <tr><th>ID</th><th>Payment ID</th><th>Target Link</th><th>Customer</th><th>Package</th><th>Price</th><th>Status</th></tr>
                </thead>
                <tbody id="ordersTable"></tbody>
            </table>
        </div>

        <div id="blogs" class="section">
            <h3 id="formTitle">Create New Blog Post</h3>
            
            <div class="blog-editor">
                <form id="blogForm">
                    <input type="hidden" id="editBlogId"> 

                    <div class="form-group">
                        <label>Blog Title</label>
                        <input type="text" id="bTitle" placeholder="e.g. How to Grow" required onkeyup="generateSlug()">
                    </div>

                    <div class="form-group">
                        <label>Slug (Auto Generated)</label>
                        <input type="text" id="bSlug" readonly style="background: #f9f9f9; color: #777;">
                    </div>
                    
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" id="bImage" placeholder="Paste image link here..." required>
                    </div>

                    <div class="form-group">
                        <label>Content (Full Article)</label>
                        <textarea id="bContent" rows="15" placeholder="Yahan apna pura blog likho..."></textarea>
                    </div>
                    
                    <div style="display: flex;">
                        <button type="submit" class="btn-publish" id="submitBtn">Publish Blog üöÄ</button>
                        <button type="button" class="btn-cancel" id="cancelBtn" onclick="resetForm()">Cancel Edit</button>
                    </div>
                </form>
            </div>

            <h3 style="margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px;">Existing Blogs</h3>
            <table>
                <thead>
                    <tr><th>Image</th><th>Title</th><th>Date</th><th>Actions</th></tr>
                </thead>
                <tbody id="blogsTable"></tbody>
            </table>
        </div>

    </div>

    <script>
        const API_URL = '/api';
        let AUTH_TOKEN = localStorage.getItem('adminToken');
        let allBlogs = []; 

        // üü¢ 2. Initialize TinyMCE (Simple & Clean)
        tinymce.init({
            selector: '#bContent',
            height: 400,
            plugins: 'link image lists table wordcount',
            toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image',
            menubar: false,
            branding: false
        });

        // Check Login on Load
        if(AUTH_TOKEN) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
        }

        async function adminLogin() {
            const password = document.getElementById('adminPass').value;
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if(data.success) {
                    localStorage.setItem('adminToken', data.token);
                    AUTH_TOKEN = data.token;
                    location.reload();
                } else {
                    document.getElementById('errorMsg').innerText = "Wrong Password! ‚ùå";
                }
            } catch(e) { alert("Login Error"); }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        function switchTab(tabName, element) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            if(element) element.classList.add('active');
        }

        function loadData() {
            fetchReviews();
            fetchOrders();
            fetchBlogs();
        }

        // --- 1. REVIEWS ---
        async function fetchReviews() {
            try {
                const res = await fetch(`${API_URL}/reviews`);
                const data = await res.json();
                const tbody = document.getElementById('reviewsTable');
                tbody.innerHTML = '';
                (data.reviews || []).forEach(r => {
                    const avatar = r.avatar ? `<img src="${r.avatar}">` : `<div style="width:40px;height:40px;background:#ddd;border-radius:50%;display:flex;align-items:center;justify-content:center;">${r.name[0]}</div>`;
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(r.date).toLocaleDateString()}</td>
                            <td style="display:flex; gap:10px; align-items:center;">${avatar}<div><strong>${r.name}</strong><br><small style="color:#6c63ff">${r.instaId}</small></div></td>
                            <td>${'‚≠ê'.repeat(r.rating)}</td>
                            <td>${r.message}</td>
                            <td><button class="delete-btn" onclick="deleteReview('${r._id}')">Delete</button></td>
                        </tr>`;
                });
            } catch(e) {}
        }
        async function deleteReview(id) {
            if(confirm("Delete Review?")) { await fetch(`${API_URL}/admin/delete-review/${id}`, {method:'DELETE', headers:{'Authorization':'SECRET_VIBESPHERE_KEY_123'}}); fetchReviews(); }
        }

        // --- 2. ORDERS ---
        async function fetchOrders() {
            try {
                const res = await fetch(`${API_URL}/admin/orders`, { headers: { 'Authorization': AUTH_TOKEN } });
                const orders = await res.json();
                const tbody = document.getElementById('ordersTable');
                tbody.innerHTML = '';
                if (orders.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No orders found</td></tr>'; return; }

                orders.forEach(o => {
                    let instaLink = o.instaLink ? `<a href="${o.instaLink}" target="_blank" style="color:#6c63ff;">Link ‚ÜóÔ∏è</a>` : 'N/A';
                    let color = o.status === 'Done' ? '#d1fae5' : '#fee2e2';
                    tbody.innerHTML += `
                        <tr>
                            <td>${o.orderId}</td>
                            <td>${o.paymentId || 'N/A'}</td>
                            <td>${instaLink}</td>
                            <td><strong>${o.customerName}</strong><br><small>${o.email}</small></td>
                            <td>${o.package}</td>
                            <td>${o.price}</td>
                            <td><select onchange="updateStatus('${o.orderId}', this.value)" style="background:${color}"><option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option><option value="Done" ${o.status==='Done'?'selected':''}>Done</option></select></td>
                        </tr>`;
                });
            } catch(e) {}
        }
        async function updateStatus(id, newStatus) {
            await fetch(`${API_URL}/admin/update-status`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': AUTH_TOKEN }, body: JSON.stringify({ id, status: newStatus }) });
            fetchOrders();
        }

        // --- 3. BLOGS ---
        async function fetchBlogs() {
            try {
                // Admin might want to see more, but for now we fetch the first 100 to keep it simple
                // In a larger app, we would add pagination controls here too
                const res = await fetch('/api/blogs?limit=100');
                const data = await res.json();
                allBlogs = data.blogs || [];

                const tbody = document.getElementById('blogsTable');
                tbody.innerHTML = '';
                if(allBlogs.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No blogs found.</td></tr>'; return; }

                allBlogs.forEach(blog => {
                    const displayTitle = blog.title || blog.titleHinglish || blog.titleHindi || "Untitled";
                    tbody.innerHTML += `
                        <tr>
                            <td><img src="${blog.image}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;"></td>
                            <td style="font-weight:600;">${displayTitle}</td>
                            <td>${new Date(blog.date).toLocaleDateString()}</td>
                            <td>
                                <button style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="prepareEdit('${blog._id}')">Edit</button>
                                <button style="background:#ff4757; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="deleteBlog('${blog._id}')">Del</button>
                            </td>
                        </tr>`;
                });
            } catch(e) { console.error("Admin Fetch Blogs Error:", e); }
        }

        // Generate Slug
        function generateSlug() {
            const title = document.getElementById('bTitle').value;
            document.getElementById('bSlug').value = title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
        }

        // Edit Mode (Modified for TinyMCE & Paginated API)
        window.prepareEdit = async function(id) {
            const blogSummary = allBlogs.find(b => b._id === id);
            if(!blogSummary) return;

            try {
                // Fetch full blog data since the list view no longer contains the content
                const res = await fetch(`/api/blog/${blogSummary.slug}`);
                const blog = await res.json();

                document.getElementById('editBlogId').value = blog._id;
                document.getElementById('bTitle').value = blog.title || blog.titleHinglish || blog.titleHindi;
                document.getElementById('bSlug').value = blog.slug;
                document.getElementById('bImage').value = blog.image;

                // üü¢ Set Data in Editor
                const content = blog.content || blog.contentHinglish || blog.contentHindi;
                tinymce.get('bContent').setContent(content || "");

                document.getElementById('formTitle').innerText = "Edit Blog Post ‚úèÔ∏è";
                document.getElementById('submitBtn').innerText = "Update Blog üîÑ";
                document.getElementById('cancelBtn').style.display = "block";
                document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                alert("Failed to fetch blog content for editing.");
                console.error(err);
            }
        }

        // Reset Form
        window.resetForm = function() {
            document.getElementById('blogForm').reset();
            tinymce.get('bContent').setContent(""); // üü¢ Clear Editor
            document.getElementById('editBlogId').value = "";
            document.getElementById('formTitle').innerText = "Create New Blog Post";
            document.getElementById('submitBtn').innerText = "Publish Blog üöÄ";
            document.getElementById('cancelBtn').style.display = "none";
        }

        // Submit (Create/Update)
        document.getElementById('blogForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editBlogId').value;
            const isEdit = id ? true : false;

            // üü¢ Get Data from Editor
            const richContent = tinymce.get('bContent').getContent();

            const blogData = {
                title: document.getElementById('bTitle').value,
                slug: document.getElementById('bSlug').value,
                image: document.getElementById('bImage').value,
                content: richContent // Use rich text
            };

            const url = isEdit ? `/api/edit-blog/${id}` : `/api/add-blog`;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(blogData) });
                const result = await res.json();
                if(result.success) {
                    alert(isEdit ? '‚úÖ Updated!' : '‚úÖ Published!');
                    resetForm();
                    fetchBlogs();
                } else { alert("Error: " + result.error); }
            } catch(e) { alert("Server Error"); }
        });

        // Delete
        window.deleteBlog = async function(id) {
            if(confirm("Delete Permanently?")) {
                await fetch(`/api/delete-blog/${id}`, { method: 'DELETE' });
                fetchBlogs();
            }
        }
    </script>
</body>
</html>
