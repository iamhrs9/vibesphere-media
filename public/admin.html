<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6B46C1; --danger: #e53e3e; --success: #2f855a; --dark: #1a1a1a; --light: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); padding: 20px; margin: 0; }
        
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        /* --- Header & Buttons --- */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--primary); font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .btn-group { display: flex; gap: 10px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-refresh { background: var(--dark); color: white; }
        .btn-pass { background: #3182ce; color: white; } /* Blue */
        .btn-logout { background: var(--danger); color: white; } /* Red */
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* --- Table Styles --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; font-weight: 600; }
        th:first-child { border-top-left-radius: 8px; } th:last-child { border-top-right-radius: 8px; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: top; }
        tr:hover { background: #f9f9f9; }

        /* --- Badges & Links --- */
        .id-badge { font-family: monospace; background: #eee; padding: 4px 8px; border-radius: 4px; color: #333; display: block; margin-bottom: 4px; font-size: 12px; }
        .pay-id { color: #007bff; border: 1px solid #cce5ff; background: #e8f4ff; }
        .status-pending { color: #d69e2e; font-weight: bold; background: #fffaf0; padding: 5px 10px; border-radius: 20px; border: 1px solid #d69e2e; }
        .status-done { color: var(--success); font-weight: bold; background: #f0fff4; padding: 5px 10px; border-radius: 20px; border: 1px solid var(--success); }
        .btn-link { color: var(--primary); text-decoration: none; font-weight: bold; background: #F3E8FF; padding: 5px 10px; border-radius: 6px; display: inline-block; margin-bottom: 8px; }
        .btn-done { background: var(--success); color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 6px; margin-top: 10px; font-size: 13px; width: 100%; }

        /* --- Modal Popup Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-box h2 { margin-top: 0; color: var(--primary); }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üìä Admin Dashboard</h1>
            <div class="btn-group">
                <button class="btn btn-refresh" onclick="loadOrders()">üîÑ Refresh</button>
                <button class="btn btn-pass" onclick="openModal()">üîë Change Password</button>
                <button class="btn btn-logout" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
        
        <table id="ordersTable">
           <thead>
            <tr>
                <th>IDs (Order & Pay)</th>
                <th>Date</th>
                <th>Customer Details</th>
                <th>Package Info</th>
                <th>Action & Status</th>
            </tr>
           </thead>
           <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="modal-overlay" id="passModal">
        <div class="modal-box">
            <h2>üîë Change Admin Password</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Note: Password will reset to default if server restarts.</p>
            <input type="password" id="oldPass" class="modal-input" placeholder="Current Password">
            <input type="password" id="newPass" class="modal-input" placeholder="New Password">
            <div class="modal-actions">
                <button class="btn btn-refresh" style="background:#ddd; color:#333;" onclick="closeModal()">Cancel</button>
                <button class="btn btn-pass" onclick="changePassword()">Update Password</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("adminToken");
        if (!token) window.location.href = "login.html";

        // --- Main Order Loading Function ---
        async function loadOrders() {
            try {
                const response = await fetch('/api/admin/orders', { headers: { 'Authorization': token } });
                if (response.status === 403) return logout(); // Token expire toh logout
                
                const orders = await response.json();
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                if(orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#666;">No Orders Yet</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const isDone = order.status === 'Done';
                    const orderId = order.orderId || order.id || 'N/A';
                    const paymentId = order.paymentId || 'N/A';

                    const row = `
                        <tr style="background: ${isDone ? '#f8f9fa' : 'white'}; opacity: ${isDone ? '0.7' : '1'}">
                            <td style="width: 220px;">
                                <span class="id-badge">üÜî ${orderId}</span>
                                <span class="id-badge pay-id">üí≥ ${paymentId}</span>
                            </td>
                            <td>${order.date || 'N/A'}</td>
                            <td>
                                <strong style="font-size:1.1em;">${order.customerName}</strong><br>
                                <span style="color:#666;">üìû ${order.phone}<br>üìß ${order.email}</span>
                            </td>
                            <td>
                                <span style="color:var(--primary); font-weight:bold; font-size:1.1em;">${order.package}</span><br>
                                <strong>‚Çπ${order.price}</strong>
                                <br><br>
                                <a href="${order.instaLink}" target="_blank" class="btn-link">üîó Instagram Profile</a>
                            </td>
                            <td style="text-align: center;">
                                ${isDone ? '<span class="status-done">‚úÖ Completed</span>' : '<span class="status-pending">üü° Pending</span>'}
                                <br>
                                ${isDone ? '' : `<button class="btn-done" onclick="markDone('${orderId}')">Mark as Done</button>`}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) { console.error("Error:", error); }
        }

        async function markDone(id) {
            if(confirm("Order complete mark karein?")) {
                await fetch('/api/admin/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ id: id, status: 'Done' })
                });
                loadOrders();
            }
        }

        // --- New Feature Functions ---

        function logout() {
            localStorage.removeItem("adminToken");
            window.location.href = "login.html";
        }

        // Modal Open/Close
        const modal = document.getElementById('passModal');
        function openModal() { 
            document.getElementById('oldPass').value = '';
            document.getElementById('newPass').value = '';
            modal.style.display = 'flex'; 
        }
        function closeModal() { modal.style.display = 'none'; }

        // Password Change API Call
        async function changePassword() {
            const oldPass = document.getElementById('oldPass').value;
            const newPass = document.getElementById('newPass').value;

            if(!oldPass || !newPass) return alert("Dono password bharein!");

            const res = await fetch('/api/admin/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ oldPassword, newPassword })
            });
            const data = await res.json();

            if(data.success) {
                alert("‚úÖ Password Change Ho Gaya!");
                closeModal();
            } else {
                alert("‚ùå Error: " + data.message);
            }
        }

        loadOrders();
    </script>
</body>
</html>