<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - VibeSphere</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f6f9; color: #333; }

        /* Login Modal */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #6c63ff; display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 350px; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; }
        .login-box button { width: 100%; padding: 12px; background: #222; color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* Dashboard */
        .dashboard { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #6c63ff; }
        .logout-btn { background: #ff4757; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #888; }
        .tab.active { color: #6c63ff; border-bottom: 3px solid #6c63ff; }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #6c63ff; color: white; }
        tr:hover { background: #f9f9f9; }

        /* Review Card Style inside Admin */
        .review-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        .delete-btn { background: #ff4757; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .delete-btn:hover { background: #ff6b81; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Admin Login üîí</h2>
            <input type="password" id="adminPass" placeholder="Enter Admin Password">
            <button onclick="adminLogin()">Access Dashboard</button>
            <p id="errorMsg" style="color: red; margin-top: 10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>VibeSphere Admin</h1>
            <button onclick="logout()" class="logout-btn">Logout <i class="ri-logout-box-r-line"></i></button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('reviews')">User Reviews</div>
            <div class="tab" onclick="switchTab('orders')">Orders (Database)</div>
        </div>

        <div id="reviews" class="section active">
            <h3>Manage Reviews</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>User</th>
                        <th>Rating</th>
                        <th>Message</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="reviewsTable">
                    </tbody>
            </table>
        </div>
<div id="orders" class="section">
    <h3>Recent Orders</h3>
    <table>
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Payment ID</th>
                <th>Target Link (Insta)</th> <th>Customer Info</th>
                <th>Package</th>
                <th>Price</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="ordersTable">
            </tbody>
    </table>
</div>
    </div>

    <script>
        const API_URL = '/api';
        let AUTH_TOKEN = localStorage.getItem('adminToken');

        // Check Login on Load
        if(AUTH_TOKEN) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
        }

        async function adminLogin() {
            const password = document.getElementById('adminPass').value;
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await res.json();

            if(data.success) {
                localStorage.setItem('adminToken', data.token);
                AUTH_TOKEN = data.token;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
            } else {
                document.getElementById('errorMsg').innerText = "Wrong Password! ‚ùå";
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // --- DATA LOADER ---
        function loadData() {
            fetchReviews();
            fetchOrders();
        }

        // 1. Fetch & Show Reviews
        async function fetchReviews() {
            const res = await fetch(`${API_URL}/reviews`);
            const data = await res.json();
            const reviews = data.reviews || []; // API se {reviews: [], stats: {}} aa raha hai
            
            const tbody = document.getElementById('reviewsTable');
            tbody.innerHTML = '';

            reviews.forEach(review => {
                const date = new Date(review.date).toLocaleDateString();
                const avatar = review.avatar ? `<img src="${review.avatar}">` : `<div style="width:40px;height:40px;background:#ddd;border-radius:50%;display:flex;align-items:center;justify-content:center;">${review.name[0]}</div>`;

                const row = `
                    <tr class="review-row">
                        <td>${date}</td>
                        <td style="display:flex; gap:10px; align-items:center;">
                            ${avatar}
                            <div>
                                <strong>${review.name}</strong><br>
                                <small style="color:#6c63ff">${review.instaId}</small>
                            </div>
                        </td>
                        <td>${'‚≠ê'.repeat(review.rating)}</td>
                        <td style="max-width:300px;">${review.message}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteReview('${review._id}')">
                                <i class="ri-delete-bin-line"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // 2. Delete Review Logic
        async function deleteReview(id) {
            if(!confirm("Are you sure you want to delete this review?")) return;

            try {
                const res = await fetch(`${API_URL}/admin/delete-review/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'SECRET_VIBESPHERE_KEY_123' } // Token bhejna zaroori hai
                });
                const data = await res.json();

                if(data.success) {
                    alert("Review Deleted! üóëÔ∏è");
                    fetchReviews(); // List refresh karo
                } else {
                    alert("Failed to delete.");
                }
            } catch(e) {
                console.error(e);
                alert("Server Error");
            }
        }

       // 3. Fetch Orders (Fixed: Added Insta Link)
async function fetchOrders() {
    try {
        const res = await fetch(`${API_URL}/admin/orders`, {
            headers: { 'Authorization': AUTH_TOKEN }
        });
        
        const orders = await res.json();
        const tbody = document.getElementById('ordersTable');
        tbody.innerHTML = '';
        
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No orders found</td></tr>';
            return;
        }

        orders.forEach(order => {
            // Status Color Logic
            let statusColor = order.status === 'Done' ? '#d1fae5' : '#fee2e2';
            let textColor = order.status === 'Done' ? '#065f46' : '#991b1b';
            
            // Insta Link Logic (Agar link hai toh clickable banao)
            let instaDisplay = order.instaLink 
                ? `<a href="https://${order.instaLink.replace('https://', '')}" target="_blank" style="color:#6c63ff; font-weight:bold; text-decoration:none;">
                     Open Link ‚ÜóÔ∏è
                   </a><br><small style="color:#555;">${order.instaLink}</small>`
                : `<span style="color:red;">Not Provided</span>`;

            const row = `
                <tr>
                    <td style="font-weight:bold;">${order.orderId}</td>
                    <td style="font-family:monospace; color:#555;">${order.paymentId || 'N/A'}</td>
                    
                    <td>${instaDisplay}</td>

                    <td>
                        <strong>${order.customerName}</strong><br>
                        <small style="color:#888;">${order.email}</small><br>
                        <small style="color:#888;">${order.phone}</small>
                    </td>
                    <td><span style="background:#f3f4f6; padding:4px 8px; border-radius:5px;">${order.package}</span></td>
                    <td style="font-weight:bold;">${order.price}</td>
                    <td>
                        <select onchange="updateStatus('${order.orderId}', this.value)" style="padding:5px; border-radius:5px; border:1px solid #ddd; background:${statusColor}; color:${textColor}; cursor:pointer;">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Done" ${order.status === 'Done' ? 'selected' : ''}>Done</option>
                        </select>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    } catch (error) {
        console.error("Order Load Error:", error);
    }
}
// Status Update Function (Agar pehle se nahi hai toh ye bhi daal lo)
async function updateStatus(id, newStatus) {
    try {
        const res = await fetch(`${API_URL}/admin/update-status`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': AUTH_TOKEN 
            },
            body: JSON.stringify({ id, status: newStatus })
        });
        
        const data = await res.json();
        if(data.success) {
            // Optional: Reload orders to update colors
            fetchOrders(); 
        } else {
            alert("Failed to update status");
        }
    } catch(e) {
        alert("Error updating status");
    }
}
    </script>
</body>
</html>