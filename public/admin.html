<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - VibeSphere</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://cdn.tiny.cloud/1/1w8pckp2kybf64f8g1fr4374ima09gr8xgr0ru01fecpzd0i/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        * { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f6f9; color: #333; }

        /* Login Modal */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #6c63ff; display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 350px; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; }
        .login-box button { width: 100%; padding: 12px; background: #222; color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* Dashboard */
        .dashboard { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #6c63ff; }
        .logout-btn { background: #ff4757; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #888; transition: 0.3s; }
        .tab:hover { color: #6c63ff; }
        .tab.active { color: #6c63ff; border-bottom: 3px solid #6c63ff; }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 15px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #6c63ff; color: white; }
        tr:hover { background: #f9f9f9; }

        /* Review Card Style inside Admin */
        .review-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        .delete-btn { background: #ff4757; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .delete-btn:hover { background: #ff6b81; }

        /* --- BLOG FORM STYLES --- */
        .blog-editor { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #6c63ff; outline: none; }
        
        .btn-publish { background: #6c63ff; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: 0.3s; }
        .btn-publish:hover { background: #5a52d5; transform: translateY(-2px); }
        
        .btn-cancel { background: #64748b; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; display: none; margin-left: 10px; }

        /* üü¢ Editor Style Fix */
        .tox-tinymce { border-radius: 8px !important; border: 1px solid #ddd !important; }

        /* --- STAFF MANAGEMENT STYLES --- */
        .staff-grid { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
        .staff-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); flex: 1; min-width: 300px; }
        .staff-card h3 { color: #333; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Admin Login üîí</h2>
            <input type="password" id="adminPass" placeholder="Enter Admin Password">
            <button onclick="adminLogin()">Access Dashboard</button>
            <p id="errorMsg" style="color: red; margin-top: 10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>VibeSphere Admin</h1>
            <button onclick="logout()" class="logout-btn">Logout <i class="ri-logout-box-r-line"></i></button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('reviews', this)">User Reviews</div>
            <div class="tab" onclick="switchTab('orders', this)">Orders (Database)</div>
            <div class="tab" onclick="switchTab('blogs', this)">Write Blog ‚úçÔ∏è</div>
            <div class="tab" onclick="switchTab('staff-section', this); fetchStaffData();">Staff Mgmt üë•</div>
            <div class="tab" onclick="switchTab('jobs-section', this); fetchAdminJobs();">Careers üíº</div>
            <div class="tab" onclick="switchTab('handover-doc', this)">Deliver Project üìÑ</div>
        </div>

        <div id="reviews" class="section active">
            <h3>Manage Reviews</h3>
            <table>
                <thead>
                    <tr><th>Date</th><th>User</th><th>Rating</th><th>Message</th><th>Action</th></tr>
                </thead>
                <tbody id="reviewsTable"></tbody>
            </table>
        </div>
<div id="handover-doc" class="section">
            <h3 style="color: #3b82f6; margin-bottom: 20px;">Generate Verified Handover PDF</h3>
            <div class="blog-editor">
                <form id="secureHandoverForm" onsubmit="generateHandover(event)">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <input type="text" id="hOrder" placeholder="Order No (e.g. #ORD-123)" required style="flex:1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="text" id="hClient" placeholder="Client Name" required style="flex:1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <input type="text" id="hProject" placeholder="Project Title" required style="flex:1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="date" id="hDelDate" required style="flex:1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" title="Delivery Date">
                        <input type="date" id="hSupDate" required style="flex:1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" title="Support Valid Till">
                    </div>
                    <input type="text" id="hLink" placeholder="Live Link / Proof URL" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <textarea id="hNotes" rows="2" placeholder="Admin Notes (Optional)" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                    
                    <button type="submit" id="btnHandover" class="btn-publish" style="width: 100%;">Create & Download Official PDF üöÄ</button>
                </form>
            </div>
        </div>
        <div id="orders" class="section">
            <h3>Recent Orders</h3>
            <table>
                <thead>
                    <tr><th>ID</th><th>Payment ID</th><th>Target Link</th><th>Customer</th><th>Package</th><th>Price</th><th>Status</th></tr>
                </thead>
                <tbody id="ordersTable"></tbody>
            </table>
        </div>

        <div id="blogs" class="section">
            <h3 id="formTitle">Create New Blog Post</h3>
            
            <div class="blog-editor">
                <form id="blogForm">
                    <input type="hidden" id="editBlogId"> 

                    <div class="form-group">
                        <label>Blog Title</label>
                        <input type="text" id="bTitle" placeholder="e.g. How to Grow" required onkeyup="generateSlug()">
                    </div>

                    <div class="form-group">
                        <label>Slug (Auto Generated)</label>
                        <input type="text" id="bSlug" readonly style="background: #f9f9f9; color: #777;">
                    </div>
                    
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" id="bImage" placeholder="Paste image link here..." required>
                    </div>

                    <div class="form-group">
                        <label>Content (Full Article)</label>
                        <textarea id="bContent" rows="15" placeholder="Yahan apna pura blog likho..."></textarea>
                    </div>
                    
                    <div style="display: flex;">
                        <button type="submit" class="btn-publish" id="submitBtn">Publish Blog üöÄ</button>
                        <button type="button" class="btn-cancel" id="cancelBtn" onclick="resetForm()">Cancel Edit</button>
                    </div>
                </form>
            </div>

            <h3 style="margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px;">Existing Blogs</h3>
            <table>
                <thead>
                    <tr><th>Image</th><th>Title</th><th>Date</th><th>Actions</th></tr>
                </thead>
                <tbody id="blogsTable"></tbody>
            </table>
        </div>

        <div id="staff-section" class="section">
            <h2>üë• Staff Management & Work Chart</h2>

            <div class="staff-grid">
                <div class="staff-card" style="max-width: 350px;">
                    <h3>Add New Staff</h3>
                    <form id="addStaffForm" style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="staffName" placeholder="Full Name" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="email" id="staffEmail" placeholder="Login Email" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="staffPassword" placeholder="Password" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select id="staffRole">
                                <option value="Sales Executive">Sales Executive</option>
                                <option value="Manager">Manager</option>
                                 <option value="Editor">Editor</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-publish" style="width: 100%;">Create Staff ID</button>
                    </form>
                </div>

                <div class="staff-card">
                    <h3>üìä Staff Work Chart</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff Email</th>
                                <th>Total Leads</th>
                                <th>Completed</th>
                                <th>Pending Calls</th>
                                <th>Action</th> </tr>
                           
                        </thead>
                        <tbody id="performanceTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
<div class="staff-card" style="margin-top: 20px;">
                <h3>üìã Manage Sent Notices</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Title</th>
                            <th>Message</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="noticesTableBody">
                        </tbody>
                </table>
            </div>
            <div class="staff-card" style="margin-top: 20px;">
                <h3>üõ°Ô∏è Manage Staff Access</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody">
                        </tbody>
                </table>
            </div>
            <div class="staff-grid" style="margin-top: 20px;">
                
                <div class="staff-card" style="border-top: 4px solid #3b82f6;">
                    <h3>üéØ Assign New Lead</h3>
                    <form id="assignLeadForm" style="display: flex; flex-direction: column; gap: 15px;" onsubmit="submitLead(event)">
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="leadClientName" placeholder="Client / Business Name" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="leadContact" placeholder="Contact Number (Phone/Insta)" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select id="leadService" required>
                                <option value="">-- Select Service to Pitch --</option>
                                <option value="Instagram Growth">Instagram Growth</option>
                                <option value="Web Development">Web Development</option>
                                <option value="Combo Package">Combo Package</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select id="leadAssignTo" required>
                                <option value="">-- Assign to Staff --</option>
                                </select>
                        </div>
                        <button type="submit" id="btnLead" class="btn-publish" style="width: 100%; background: #3b82f6;">Assign Lead üöÄ</button>
                    </form>
                </div>

                <div class="staff-card" style="border-top: 4px solid #10b981;">
                    <h3>üì¢ Post Notice (Board)</h3>
                    <form id="addNoticeForm" style="display: flex; flex-direction: column; gap: 15px;" onsubmit="submitNotice(event)">
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="noticeTitle" placeholder="Notice Title (e.g., Target Update!)" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <textarea id="noticeMessage" rows="5" placeholder="Type your full message here..." required></textarea>
                        </div>
                        <button type="submit" id="btnNotice" class="btn-publish" style="width: 100%; background: #10b981;">Send Notice üîî</button>
                    </form>
                </div>
                
            </div>
        </div>

    </div>
    <div id="staffWorkModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; width: 90%; max-width: 800px; padding: 25px; border-radius: 12px; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <button onclick="closeStaffWork()" style="position: absolute; right: 20px; top: 20px; background: #ff4757; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">Close ‚ùå</button>
            <h2 id="workModalTitle" style="margin-bottom: 20px; color: #6c63ff;">Work Details</h2>
            <table>
                <thead>
                    <tr>
                        <th>Client / Contact</th>
                        <th>Service</th>
                        <th>Status</th>
                        <th>Staff Review (Notes)</th>
                    </tr>
                </thead>
                <tbody id="workModalBody">
                    </tbody>
            </table>
        </div>
    </div>
    <div id="jobs-section" class="section">
            <h2>üíº Manage Job Postings</h2>

            <div class="staff-grid" style="margin-top: 20px;">
                <div class="staff-card" style="border-top: 4px solid #8b5cf6; max-width: 400px;">
                    <h3>Post a New Job</h3>
                    <form id="addJobForm" style="display: flex; flex-direction: column; gap: 15px;" onsubmit="submitJob(event)">
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="jobTitle" placeholder="Job Title (e.g. Video Editor)" required>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <select id="jobType" required style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="Full-time">Full-time</option>
                                <option value="Part-time">Part-time</option>
                                <option value="Internship">Internship</option>
                                <option value="Freelance">Freelance</option>
                            </select>
                            <select id="jobLocation" required style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="Remote">Remote</option>
                                <option value="On-site">On-site</option>
                                <option value="Hybrid">Hybrid</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <textarea id="jobDesc" rows="4" placeholder="Short description of the role..." required></textarea>
                        </div>
                        <button type="submit" id="btnJob" class="btn-publish" style="background: #8b5cf6;">Post Job üöÄ</button>
                    </form>
                </div>

                <div class="staff-card" style="flex: 1;">
                    <h3>Active Job Postings</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Type & Location</th>
                                <th>Posted On</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
 <script>
    const API_URL = '/api';
    let AUTH_TOKEN = localStorage.getItem('adminToken');
    let allBlogs = []; 
    let globalPerformanceData = {}; // üü¢ Data save karne ke liye global variable

    // üü¢ 1. Initialize TinyMCE (For Blogs)
    tinymce.init({
        selector: '#bContent',
        height: 400,
        plugins: 'link image lists table wordcount',
        toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image',
        menubar: false,
        branding: false
    });

    // Check Login on Load
    if(AUTH_TOKEN) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadData();
    }

    async function adminLogin() {
        const password = document.getElementById('adminPass').value;
        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await res.json();
            if(data.success) {
                localStorage.setItem('adminToken', data.token);
                AUTH_TOKEN = data.token;
                location.reload();
            } else {
                document.getElementById('errorMsg').innerText = "Wrong Password! ‚ùå";
            }
        } catch(e) { alert("Login Error"); }
    }

    function logout() {
        localStorage.removeItem('adminToken');
        location.reload();
    }

    function switchTab(tabName, element) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        if(element) element.classList.add('active');
    }

    function loadData() {
        fetchReviews();
        fetchOrders();
        fetchBlogs();
        fetchStaffData(); // Naya: Staff data bhi load karo
            fetchNoticesAdmin();
    }

    // ==========================================
    // 1. REVIEWS MANAGEMENT
    // ==========================================
    async function fetchReviews() {
        try {
            const res = await fetch(`${API_URL}/reviews`);
            const data = await res.json();
            const tbody = document.getElementById('reviewsTable');
            tbody.innerHTML = '';
            (data.reviews || []).forEach(r => {
                const avatar = r.avatar ? `<img src="${r.avatar}">` : `<div style="width:40px;height:40px;background:#ddd;border-radius:50%;display:flex;align-items:center;justify-content:center;">${r.name[0]}</div>`;
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(r.date).toLocaleDateString()}</td>
                        <td style="display:flex; gap:10px; align-items:center;">${avatar}<div><strong>${r.name}</strong><br><small style="color:#6c63ff">${r.instaId}</small></div></td>
                        <td>${'‚≠ê'.repeat(r.rating)}</td>
                        <td>${r.message}</td>
                        <td><button class="delete-btn" onclick="deleteReview('${r._id}')">Delete</button></td>
                    </tr>`;
            });
        } catch(e) {}
    }
    
    async function deleteReview(id) {
        if(confirm("Delete Review?")) { 
            await fetch(`${API_URL}/admin/delete-review/${id}`, {method:'DELETE', headers:{'Authorization': AUTH_TOKEN}}); 
            fetchReviews(); 
        }
    }

    // ==========================================
    // 2. ORDERS MANAGEMENT
    // ==========================================
    async function fetchOrders() {
        try {
            const res = await fetch(`${API_URL}/admin/orders`, { headers: { 'Authorization': AUTH_TOKEN } });
            const orders = await res.json();
            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';
            if (orders.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No orders found</td></tr>'; return; }

            orders.forEach(o => {
                let instaLink = o.instaLink ? `<a href="${o.instaLink}" target="_blank" style="color:#6c63ff;">Link ‚ÜóÔ∏è</a>` : 'N/A';
                let color = o.status === 'Done' ? '#d1fae5' : '#fee2e2';
                tbody.innerHTML += `
                    <tr>
                        <td>${o.orderId}</td>
                        <td>${o.paymentId || 'N/A'}</td>
                        <td>${instaLink}</td>
                        <td><strong>${o.customerName}</strong><br><small>${o.email}</small></td>
                        <td>${o.package}</td>
                        <td>${o.price}</td>
                        <td style="display:flex; gap:10px; align-items:center;">
    <select onchange="updateStatus('${o.orderId}', this.value)" style="background:${color}; border-radius:5px; padding:5px;">
        <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
        <option value="Done" ${o.status==='Done'?'selected':''}>Done</option>
    </select>
    <button onclick="window.open('/api/download-invoice/${encodeURIComponent(o.orderId)}')" style="background:#8b5cf6; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" title="Download Invoice">üì• PDF</button>
</td>
                    </tr>`;
            });
        } catch(e) {}
    }

    async function updateStatus(id, newStatus) {
        await fetch(`${API_URL}/admin/update-status`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': AUTH_TOKEN }, body: JSON.stringify({ id, status: newStatus }) });
        fetchOrders();
    }

    // ==========================================
    // 3. BLOGS MANAGEMENT
    // ==========================================
    async function fetchBlogs() {
        try {
            const res = await fetch('/api/blogs');
            allBlogs = await res.json();
            const tbody = document.getElementById('blogsTable');
            tbody.innerHTML = '';
            if(allBlogs.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No blogs found.</td></tr>'; return; }

            allBlogs.forEach(blog => {
                const displayTitle = blog.title || blog.titleHinglish || blog.titleHindi || "Untitled";
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${blog.image}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;"></td>
                        <td style="font-weight:600;">${displayTitle}</td>
                        <td>${new Date(blog.date).toLocaleDateString()}</td>
                        <td>
                            <button style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="prepareEdit('${blog._id}')">Edit</button>
                            <button style="background:#ff4757; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="deleteBlog('${blog._id}')">Del</button>
                        </td>
                    </tr>`;
            });
        } catch(e) {}
    }

    function generateSlug() {
        const title = document.getElementById('bTitle').value;
        document.getElementById('bSlug').value = title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
    }

    window.prepareEdit = function(id) {
        const blog = allBlogs.find(b => b._id === id);
        if(!blog) return;

        document.getElementById('editBlogId').value = blog._id;
        document.getElementById('bTitle').value = blog.title || blog.titleHinglish || blog.titleHindi;
        document.getElementById('bSlug').value = blog.slug;
        document.getElementById('bImage').value = blog.image;
        
        const content = blog.content || blog.contentHinglish || blog.contentHindi;
        tinymce.get('bContent').setContent(content || "");

        document.getElementById('formTitle').innerText = "Edit Blog Post ‚úèÔ∏è";
        document.getElementById('submitBtn').innerText = "Update Blog üîÑ";
        document.getElementById('cancelBtn').style.display = "block";
        document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });
    }

    window.resetForm = function() {
        document.getElementById('blogForm').reset();
        tinymce.get('bContent').setContent(""); 
        document.getElementById('editBlogId').value = "";
        document.getElementById('formTitle').innerText = "Create New Blog Post";
        document.getElementById('submitBtn').innerText = "Publish Blog üöÄ";
        document.getElementById('cancelBtn').style.display = "none";
    }

    document.getElementById('blogForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editBlogId').value;
        const isEdit = id ? true : false;
        const richContent = tinymce.get('bContent').getContent();

        const blogData = {
            title: document.getElementById('bTitle').value,
            slug: document.getElementById('bSlug').value,
            image: document.getElementById('bImage').value,
            content: richContent 
        };

        const url = isEdit ? `/api/edit-blog/${id}` : `/api/add-blog`;
        const method = isEdit ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(blogData) });
            const result = await res.json();
            if(result.success) {
                alert(isEdit ? '‚úÖ Updated!' : '‚úÖ Published!');
                resetForm();
                fetchBlogs();
            } else { alert("Error: " + result.error); }
        } catch(e) { alert("Server Error"); }
    });

    window.deleteBlog = async function(id) {
        if(confirm("Delete Permanently?")) {
            await fetch(`/api/delete-blog/${id}`, { method: 'DELETE' });
            fetchBlogs();
        }
    }

    // ==========================================
    // üü¢ 4. STAFF MANAGEMENT 
    // ==========================================
    async function fetchStaffData() {
        try {
            // A. Fetch Staff List
            const staffRes = await fetch('/api/admin/staff', { headers: { 'Authorization': AUTH_TOKEN } });
            const staffData = await staffRes.json();
            
            const staffTbody = document.getElementById('staffTableBody');
            staffTbody.innerHTML = '';
            
            // Dropdown clear karo
            const assignDropdown = document.getElementById('leadAssignTo');
            assignDropdown.innerHTML = '<option value="">-- Assign to Staff --</option>';

            if (staffData.success && staffData.staff) {
                staffData.staff.forEach(s => {
                    // Table update
                    staffTbody.innerHTML += `
                    <tr>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.email}</td>
                        <td><span style="background:#e0e7ff; color:#4f46e5; padding:3px 8px; border-radius:10px; font-size:12px;">${s.role}</span></td>
                        <td>
                            <button onclick="deleteStaff('${s._id}')" class="delete-btn">Delete ID</button>
                        </td>
                    </tr>`;
                    
                    // Dropdown me options add karo
                    assignDropdown.innerHTML += `<option value="${s.email}">${s.name} (${s.role})</option>`;
                });
            }

            // B. Fetch Performance Chart
            const perfRes = await fetch('/api/admin/staff-performance', { headers: { 'Authorization': AUTH_TOKEN } });
            const perfData = await perfRes.json();
            
            const perfTbody = document.getElementById('performanceTableBody');
            perfTbody.innerHTML = '';
            
            if (perfData.success && perfData.performance) {
                globalPerformanceData = perfData.performance; // Data save kiya
                
                for(let email in perfData.performance) {
                    let p = perfData.performance[email];
                    perfTbody.innerHTML += `
                    <tr>
                        <td><strong>${email}</strong></td>
                        <td style="font-weight:bold;">${p.total}</td>
                        <td style="color:#16a34a;">${p.completed} ‚úì</td>
                        <td style="color:#dc2626;">${p.pending} ‚è≥</td>
                        <td>
                            <button onclick="viewStaffWork('${email}')" class="btn-publish" style="padding: 5px 10px; font-size: 12px;">View Details üëÅÔ∏è</button>
                        </td>
                    </tr>`;
                }
            }
        } catch(e) { console.error("Error fetching staff data:", e); }
    }

    // Add New Staff
    document.getElementById('addStaffForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.innerText = "Creating...";

        const newStaff = {
            name: document.getElementById('staffName').value,
            email: document.getElementById('staffEmail').value,
            password: document.getElementById('staffPassword').value,
            role: document.getElementById('staffRole').value
        };

        try {
            const res = await fetch('/api/admin/add-staff', {
                method: 'POST',
                headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify(newStaff)
            });
            const result = await res.json();
            if(result.success) {
                alert("‚úÖ " + result.message);
                document.getElementById('addStaffForm').reset();
                fetchStaffData(); // Form reset karke list ko refresh karo
            } else {
                alert("‚ùå Error: " + result.error);
            }
        } catch(err) { alert("Server connection failed"); }
        
        btn.innerText = "Create Staff ID";
    });

    // Delete Staff
    window.deleteStaff = async function(id) {
        if(!confirm("Are you sure? Is staff ka access delete ho jayega!")) return;
        
        try {
            const res = await fetch(`/api/admin/delete-staff/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': AUTH_TOKEN }
            });
            const result = await res.json();
            if(result.success) {
                fetchStaffData(); // List ko turant refresh karo
            }
        } catch(e) { alert("Failed to delete staff."); }
    }

    // ==========================================
    // üü¢ 5. ASSIGN LEADS & NOTICES 
    // ==========================================
    
    // 1. Submit Lead Function
    window.submitLead = async function(e) {
        e.preventDefault(); 
        
        const btn = document.getElementById('btnLead');
        btn.innerText = "Assigning...";

        const taskData = {
            clientName: document.getElementById('leadClientName').value,
            contactNumber: document.getElementById('leadContact').value,
            servicePitch: document.getElementById('leadService').value,
            assignedTo: document.getElementById('leadAssignTo').value
        };

        try {
            const res = await fetch('/api/admin/add-task', {
                method: 'POST',
                headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            });
            const result = await res.json();
            
            if(result.success) {
                alert("‚úÖ " + result.message);
                document.getElementById('assignLeadForm').reset();
                fetchStaffData(); // Naya lead aate hi chart update ho jayega
            } else { 
                alert("‚ùå Error: " + result.error); 
            }
        } catch(err) { 
            alert("Server connection failed"); 
        }
        btn.innerText = "Assign Lead üöÄ";
    };

    // 2. Submit Notice Function
    window.submitNotice = async function(e) {
        e.preventDefault(); 
        
        const btn = document.getElementById('btnNotice');
        btn.innerText = "Posting...";

        const noticeData = {
            title: document.getElementById('noticeTitle').value,
            message: document.getElementById('noticeMessage').value
        };

        try {
            const res = await fetch('/api/admin/add-notice', {
                method: 'POST',
                headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify(noticeData)
            });
            const result = await res.json();
            
            if(result.success) {
                alert("‚úÖ " + result.message);
                document.getElementById('addNoticeForm').reset();
            } else { 
                alert("‚ùå Error: " + result.error); 
            }
        } catch(err) { 
            alert("Server connection failed"); 
        }
        btn.innerText = "Send Notice üîî";
        if(result.success) {
                alert("‚úÖ " + result.message);
                document.getElementById('addNoticeForm').reset();
                fetchNoticesAdmin(); // üö® YEH LINE ADD KARNI HAI (Naya notice turant table me dikhega)
            }
    }

    // ==========================================
    // üü¢ 6. VIEW DETAILED STAFF WORK
    // ==========================================
    window.viewStaffWork = function(email) {
        const data = globalPerformanceData[email];
        if(!data || !data.details) return;

        document.getElementById('workModalTitle').innerText = `Work Details: ${email}`;
        const tbody = document.getElementById('workModalBody');
        tbody.innerHTML = '';

        if(data.details.length === 0) {
            tbody.innerHTML = '<tr><td colspan=\"4\" style=\"text-align:center;\">No leads assigned yet.</td></tr>';
        } else {
            data.details.forEach(task => {
                let statusColor = '#333';
                if(task.status === 'pending' || task.status === 'call-back') statusColor = 'orange';
                if(task.status === 'interested') statusColor = 'green';
                if(task.status === 'rejected' || task.status === 'not-answering') statusColor = 'red';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${task.clientName}</strong><br><small>${task.contactNumber}</small></td>
                        <td>${task.servicePitch}</td>
                        <td style="color:${statusColor}; font-weight:bold; text-transform:uppercase; font-size:12px;">${task.status}</td>
                        <td style="background: #f9f9f9; font-style: italic;">${task.notes || '<span style="color:#999;">No review yet</span>'}</td>
                    </tr>
                `;
            });
        }
        document.getElementById('staffWorkModal').style.display = 'flex';
    }

    window.closeStaffWork = function() {
        document.getElementById('staffWorkModal').style.display = 'none';
    }
        // ==========================================
    // üü¢ 7. MANAGE NOTICES (FETCH & DELETE)
    // ==========================================
    
    // 1. Fetch Notices for Admin
    async function fetchNoticesAdmin() {
        try {
            const res = await fetch('/api/admin/notices', { headers: { 'Authorization': AUTH_TOKEN } });
            const data = await res.json();
            const tbody = document.getElementById('noticesTableBody');
            tbody.innerHTML = '';
            
            if(data.success && data.notices) {
                if(data.notices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No notices sent yet.</td></tr>';
                    return;
                }
                data.notices.forEach(n => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${new Date(n.date).toLocaleDateString()}</td>
                        <td><strong>${n.title}</strong></td>
                        <td>${n.message}</td>
                        <td><button onclick="deleteNotice('${n._id}')" class="delete-btn">Delete</button></td>
                    </tr>`;
                });
            }
        } catch(e) { console.error("Error fetching notices"); }
    }

    // 2. Delete Notice Function
    window.deleteNotice = async function(id) {
        if(confirm("Are you sure? Yeh notice sabke dashboard se hat jayega!")) {
            try {
                const res = await fetch(`/api/admin/delete-notice/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': AUTH_TOKEN }
                });
                const result = await res.json();
                if(result.success) {
                    fetchNoticesAdmin(); // Delete hone ke baad table refresh karo
                }
            } catch(e) { alert("Failed to delete notice"); }
        }
    }; 
    // ==========================================
    // üü¢ 8. MANAGE CAREERS / JOBS
    // ==========================================
    
    // 1. Fetch & Show Jobs in Admin
    window.fetchAdminJobs = async function() {
        try {
            const res = await fetch('/api/jobs');
            const data = await res.json();
            const tbody = document.getElementById('jobsTableBody');
            tbody.innerHTML = '';
            
            if(data.success && data.jobs) {
                if(data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No jobs posted right now.</td></tr>';
                    return;
                }
                data.jobs.forEach(job => {
                    tbody.innerHTML += `
                    <tr>
                        <td><strong>${job.title}</strong></td>
                        <td>${job.type} ‚Ä¢ ${job.location}</td>
                        <td>${new Date(job.date).toLocaleDateString()}</td>
                        <td><button onclick="deleteJob('${job._id}')" class="delete-btn">Remove</button></td>
                    </tr>`;
                });
            }
        } catch(e) { console.error("Error fetching jobs"); }
    }

    // 2. Submit New Job
    window.submitJob = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnJob');
        btn.innerText = "Posting...";

        const jobData = {
            title: document.getElementById('jobTitle').value,
            type: document.getElementById('jobType').value,
            location: document.getElementById('jobLocation').value,
            description: document.getElementById('jobDesc').value
        };

        try {
            const res = await fetch('/api/admin/add-job', {
                method: 'POST',
                headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify(jobData)
            });
            const result = await res.json();
            
            if(result.success) {
                alert("‚úÖ " + result.message);
                document.getElementById('addJobForm').reset();
                fetchAdminJobs(); // Table update
            } else { alert("‚ùå Error: " + result.error); }
        } catch(err) { alert("Server connection failed"); }
        
        btn.innerText = "Post Job üöÄ";
    };

    // 3. Delete Job
    window.deleteJob = async function(id) {
        if(confirm("Are you sure? This job will be removed from the public website!")) {
            try {
                const res = await fetch(`/api/admin/delete-job/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': AUTH_TOKEN }
                });
                const result = await res.json();
                if(result.success) fetchAdminJobs();
            } catch(e) { alert("Failed to delete job"); }
        }
    };
    async function generateHandover(e) {
        e.preventDefault();
        const btn = document.getElementById('btnHandover');
        btn.innerText = "Processing Document...";

        const payload = {
            orderNumber: document.getElementById('hOrder').value,
            clientName: document.getElementById('hClient').value,
            projectName: document.getElementById('hProject').value,
            deliveryDate: document.getElementById('hDelDate').value,
            supportDate: document.getElementById('hSupDate').value,
            liveLink: document.getElementById('hLink').value,
            remarks: document.getElementById('hNotes').value
        };

        try {
            // Secure API Call (Auth Token sent)
            const res = await fetch('/api/admin/generate-handover', {
                method: 'POST',
                headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                // PDF Download Logic (Browser Trick)
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `VibeSphere_Handover_${payload.orderNumber}.pdf`;
                a.click();
                document.getElementById('secureHandoverForm').reset();
            } else { alert("Failed to generate PDF. Check auth."); }
        } catch (err) { alert("Server error"); }
        
        btn.innerText = "Create & Download Official PDF üöÄ";
    };

</script>
</body>
</html>