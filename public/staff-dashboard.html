<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard | VibeSphere Media</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="staff-dashboard-bg">

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>VibeSphere<span>.</span></h2>
                <p>Staff Portal</p>
            </div>
           <ul class="sidebar-menu">
                <li id="nav-dashboard" class="active" onclick="switchTab('dashboard')"><i class="ri-dashboard-line"></i> Dashboard</li>
                <li id="nav-tasks" onclick="switchTab('tasks')"><i class="ri-list-check"></i> My Tasks</li>
                <li id="nav-notices" onclick="switchTab('notices')"><i class="ri-notification-3-line"></i> Notice Board</li>
                <li onclick="openIDCard()"><i class="ri-profile-line"></i> My ID Card</li>
            </ul>
        </aside>

       <main class="main-content">
            <header class="dashboard-header">
                <div>
                    <h1>Welcome back, Staff! üëã</h1>
                    <p>Here is your summary for today.</p>
                </div>
                <div class="header-profile" style="position: relative;">
                    <img id="headerProfileImg" class="profile-circle" onclick="toggleProfileMenu()" style="cursor: pointer; width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid #7d5fff; padding: 0;" src="">
                    <div id="profile-menu" class="profile-dropdown" style="display: none;">
                        <div class="dropdown-header">
                            <strong>Staff Name</strong>
                            <span>staff@vibespheremedia.com</span>
                        </div>
                        <ul>
                            <li onclick="switchTab('settings'); toggleProfileMenu();"><i class="ri-user-settings-line"></i> Account Settings</li>
                            <li style="color: #dc2626;" onclick="staffLogout()">
                                <i class="ri-logout-box-r-line"></i> Logout
                            </li>
                        </ul>
                    </div>
                </div>
            </header>

            <div id="view-dashboard" class="tab-content" style="display: block;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #e0e7ff; color: #4f46e5;"><i class="ri-briefcase-4-line"></i></div>
                        <div class="stat-info">
                            <h3>0</h3>
                            <p>Total Assigned</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #dcfce7; color: #16a34a;"><i class="ri-checkbox-circle-line"></i></div>
                        <div class="stat-info">
                            <h3>0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fee2e2; color: #dc2626;"><i class="ri-time-line"></i></div>
                        <div class="stat-info">
                            <h3>0</h3>
                            <p>Pending Calls</p>
                        </div>
                    </div>
                </div>

                <section class="task-section">
                    <div class="section-header">
                        <h2>Today's Pending Leads</h2>
                    </div>
                    <div class="task-table-wrapper">
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th>Client Name</th>
                                    <th>Contact Number</th>
                                    <th>Service Pitch</th>
                                    <th>Status</th>
                                    <th>Notes / Reason</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="view-tasks" class="tab-content" style="display: none;">
                <section class="task-section">
                    <div class="section-header">
                        <h2>All Assigned Leads (History)</h2>
                    </div>
                    <div class="task-table-wrapper">
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th>Client Name</th>
                                    <th>Contact Number</th>
                                    <th>Service Pitch</th>
                                    <th>Status</th>
                                    <th>Notes / Reason</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="view-notices" class="tab-content" style="display: none;">
                <section class="task-section" style="background: transparent; box-shadow: none; border: none; padding: 0;">
                    <div class="section-header">
                        <h2>üì¢ Official Notice Board</h2>
                    </div>
                    <div id="noticeContainer">
                        <p style="color: #64748b;">Loading notices...</p>
                    </div>
                </section>
            </div>

            <div id="view-settings" class="tab-content" style="display: none;">
                <section class="task-section">
                    <div class="section-header">
                        <h2>‚öôÔ∏è Account Settings</h2>
                    </div>
                    <div class="settings-container">
                        <div class="settings-card">
                            <h3>Profile Picture</h3>
                            <div class="avatar-upload-settings">
                                <img id="settings-avatar-preview" src="" alt="Profile">
                                <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
                                <label for="profilePhotoInput" class="btn-outline" style="text-align: center; display: inline-block; width: 100%;">Select Photo</label>
                                <button class="btn-update" id="savePhotoBtn" onclick="saveProfilePhoto()" style="width: 100%; display: none; margin-top: 10px;">Update Photo</button>
                            </div>
                        </div>
                        <div class="settings-card">
                            <h3>Change Password</h3>
                            <div class="input-group">
                                <label>Current Password</label>
                                <input type="password" id="currentPassword" placeholder="Enter current password">
                            </div>
                            <div class="input-group">
                                <label>New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password">
                            </div>
                            <button class="btn-update" style="width: 100%;" onclick="updatePassword()">Update Password</button>
                        </div>
                    </div>
                </section>
            </div>

            <div id="idCardModal" class="modal-overlay" style="display: none;">
                <div class="modal-content" style="max-width: 350px; text-align: center;">
                    <span class="close-btn" onclick="closeIDCard()" style="position: absolute; right: 20px; top: 15px; cursor: pointer;">&times;</span>
                    <div class="id-card-wrapper" id="printableIDCard">
                        <div class="id-card">
                            <div class="id-header">
                                <h2>VibeSphere<span>.</span></h2>
                                <p>MEDIA AGENCY</p>
                            </div>
                            <div class="id-photo">
                                <img id="idCardPhoto" src="" alt="Staff">
                            </div>
                            <div class="id-details">
                                <h3 id="idCardName">Staff Name</h3>
                                <p id="idCardRole" class="role">Role</p>
                                <div class="id-info">
                                    <p><strong>EMP ID:</strong> <span id="idCardEmpId">Loading...</span></p>
                                    <p><strong>Email:</strong> <span id="idCardEmail">email@vibespheremedia.com</span></p>
                                </div>
                            </div>
                            <div class="id-footer">
                                <p>Authorized Staff Identity</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn-update" onclick="printIDCard()" style="width: 100%; margin-top: 25px; padding: 12px; font-size: 16px;">
                        <i class="ri-download-2-line"></i> Download / Print ID
                    </button>
                </div>
            </div>
        </main>
    </div>

<script>
    // ==========================================
    // 1. SECURITY & PROFILE SETUP
    // ==========================================
    const staffData = JSON.parse(localStorage.getItem('staffData'));

    if (!staffData) {
        window.location.href = 'staff-login.html';
    } else {
        // Photo setup
        const defaultDp = `https://ui-avatars.com/api/?name=${staffData.name}&background=7d5fff&color=fff&size=200`;
        const finalDp = staffData.profilePhoto ? staffData.profilePhoto : defaultDp;

        if (document.getElementById('idCardPhoto')) document.getElementById('idCardPhoto').src = finalDp;
        if (document.getElementById('settings-avatar-preview')) document.getElementById('settings-avatar-preview').src = finalDp;
        if (document.getElementById('headerProfileImg')) document.getElementById('headerProfileImg').src = finalDp;
        
        // Setup text info
        const firstName = staffData.name.split(' ')[0];
        document.querySelector('.dashboard-header h1').innerHTML = `Welcome back, ${firstName}! üëã`;
        document.querySelector('.dropdown-header strong').innerText = staffData.name;
        document.querySelector('.dropdown-header span').innerText = staffData.email;

        // ID Card Setup
        document.getElementById('idCardName').innerText = staffData.name;
        document.getElementById('idCardEmail').innerText = staffData.email;
        document.getElementById('idCardRole').innerText = staffData.role || 'Sales Executive';
        
        // üö® NAYA: Asli Employee ID set hogi yahan
        document.getElementById('idCardEmpId').innerText = staffData.empId || 'Please ask Admin to recreate your ID';
    }

    // LOGOUT FUNCTION (Zaroori hai cache clear karne ke liye)
    function staffLogout() {
        localStorage.removeItem('staffData');
        window.location.href = 'staff-login.html';
    }

    // ==========================================
    // 2. UI FUNCTIONS (TABS & MENU)
    // ==========================================
    function switchTab(tabId) {
        let contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => content.style.display = 'none');

        let navItems = document.querySelectorAll('.sidebar-menu li');
        navItems.forEach(item => item.classList.remove('active'));

        const viewElement = document.getElementById('view-' + tabId);
        if (viewElement) viewElement.style.display = 'block';

        const navElement = document.getElementById('nav-' + tabId);
        if (navElement) navElement.classList.add('active'); 
    }

    function toggleProfileMenu() {
        const menu = document.getElementById('profile-menu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    window.onclick = function(event) {
        if (!event.target.matches('.profile-circle')) {
            const menu = document.getElementById('profile-menu');
            if (menu && menu.style.display === 'block') menu.style.display = 'none';
        }
    }

    function openIDCard() { document.getElementById('idCardModal').style.display = 'flex'; }
    function closeIDCard() { document.getElementById('idCardModal').style.display = 'none'; }
    function printIDCard() { window.print(); }

    // ==========================================
    // 3. FETCH DATA (TASKS & NOTICES)
    // ==========================================
    
    // NAYA FUNCTION: NOTICES FETCH KARNE KE LIYE
    async function fetchNotices() {
        try {
            const response = await fetch('/api/staff/notices');
            const data = await response.json();
            const container = document.getElementById('noticeContainer');
            
            if(data.success && data.notices.length > 0) {
                container.innerHTML = '';
                data.notices.forEach((notice, index) => {
                    // Colors alternate karne ke liye
                    let borderColor = index % 2 === 0 ? '#6c63ff' : '#10b981';
                    
                    container.innerHTML += `
                        <div class="notice-card" style="border-left-color: ${borderColor};">
                            <span class="notice-date">${new Date(notice.date).toLocaleString()}</span>
                            <h3>${notice.title}</h3>
                            <p>${notice.message}</p>
                            <div class="notice-author">By ${notice.author}</div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<p style="color: #64748b;">No new notices at the moment.</p>';
            }
        } catch(e) {
            console.error("Notice fetch error:", e);
        }
    }

    async function fetchMyTasks() {
        try {
            const response = await fetch('/api/staff/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: staffData.email })
            });
            const data = await response.json();
            if(data.success) renderDashboard(data.tasks);
        } catch(e) {
            console.error("Task fetch error:", e);
        }
    }

    // Call functions on load
    if(staffData) {
        fetchMyTasks();
        fetchNotices(); // Page khulte hi notice load hoga
    }
    // ==========================================
    // 4. RENDER TASKS & UPDATE
    // ==========================================
    function renderDashboard(tasks) {
        // Dono tables ko select karo
        const dashTbody = document.querySelector('#view-dashboard .task-table tbody');
        const tasksTbody = document.querySelector('#view-tasks .task-table tbody');
        
        if(dashTbody) dashTbody.innerHTML = ''; 
        if(tasksTbody) tasksTbody.innerHTML = '';
        
        let completed = 0;
        let pending = 0;

        if(tasks.length === 0) {
            const emptyMsg = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: #64748b; font-size: 16px;">
                <i class="ri-cup-line" style="font-size: 30px; display: block; margin-bottom: 10px; color: #cbd5e1;"></i>
                No leads assigned yet! Relax üéâ
            </td></tr>`;
            if(dashTbody) dashTbody.innerHTML = emptyMsg;
            if(tasksTbody) tasksTbody.innerHTML = emptyMsg;
        } else {
            tasks.forEach(task => {
                if(task.status === 'interested' || task.status === 'rejected') completed++;
                else pending++;

                const trHTML = `
                    <td><strong>${task.clientName}</strong><br><span class="sub-text">${task.clientType || 'Lead'}</span></td>
                    <td>${task.contactNumber}</td>
                    <td><span class="badge-service">${task.servicePitch}</span></td>
                    <td>
                        <select class="status-dropdown">
                            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="interested" ${task.status === 'interested' ? 'selected' : ''}>‚úÖ Interested</option>
                            <option value="not-answering" ${task.status === 'not-answering' ? 'selected' : ''}>üìµ Not Answering</option>
                            <option value="call-back" ${task.status === 'call-back' ? 'selected' : ''}>üìû Call Back Tom</option>
                            <option value="rejected" ${task.status === 'rejected' ? 'selected' : ''}>‚ùå Rejected</option>
                        </select>
                    </td>
                    <td><input type="text" class="notes-input" value="${task.notes || ''}" placeholder="Type feedback..."></td>
                    <td><button class="btn-update" onclick="updateTask(this, '${task._id}')">Save</button></td>
                `;
                
                // 1. Dashboard tab mein sirf "Pending/Call-back" wale dikhao
                if(dashTbody && (task.status === 'pending' || task.status === 'call-back' || task.status === 'not-answering')) {
                    const tr1 = document.createElement('tr');
                    tr1.innerHTML = trHTML;
                    dashTbody.appendChild(tr1);
                }
                
                // 2. "My Tasks" tab mein SAB kuch dikhao (History ke liye)
                if(tasksTbody) {
                    const tr2 = document.createElement('tr');
                    tr2.innerHTML = trHTML;
                    tasksTbody.appendChild(tr2);
                }
            });
            
            // Agar saara kaam khatam ho gaya (Dashboard khaali hai)
            if(dashTbody && dashTbody.innerHTML === '') {
                 dashTbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: #16a34a; font-size: 16px;">
                    <i class="ri-checkbox-circle-fill" style="font-size: 30px; display: block; margin-bottom: 10px;"></i>
                    All caught up for today! Check 'My Tasks' for completed leads.
                </td></tr>`;
            }
        }

        const statCards = document.querySelectorAll('.stat-info h3');
        if(statCards.length > 0) {
            statCards[0].innerText = tasks.length; 
            statCards[1].innerText = completed;    
            statCards[2].innerText = pending;      
        }
    }

    async function updateTask(btnElement, taskId) {
        // Jis button par click kiya hai, uski row ka data uthao
        const row = btnElement.closest('tr');
        const status = row.querySelector('.status-dropdown').value;
        const notes = row.querySelector('.notes-input').value;
        
        const originalText = btnElement.innerText;
        btnElement.innerText = "Saving...";
        
        try {
            const response = await fetch('/api/staff/update-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId, status, notes })
            });
            const data = await response.json();
            
            if(data.success) {
                btnElement.innerText = "Saved ‚úì";
                btnElement.style.background = "#16a34a";
                setTimeout(() => { 
                    fetchMyTasks(); // Page auto-refresh hokar lead sahi tab mein chali jayegi
                }, 1500);
            }
        } catch(e) {
            alert("Error saving task! Check your internet.");
            btnElement.innerText = originalText;
        }
    }

    // ==========================================
    // 5. ACCOUNT SETTINGS (PASSWORD & PHOTO)
    // ==========================================
    async function updatePassword() {
        const currentPwd = document.getElementById('currentPassword').value;
        const newPwd = document.getElementById('newPassword').value;
        
        if(!currentPwd || !newPwd) return alert("Please fill both password fields!");

        const btn = document.querySelector('button[onclick="updatePassword()"]');
        btn.innerText = "Updating...";

        try {
            const response = await fetch('/api/staff/update-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: staffData.email, currentPassword: currentPwd, newPassword: newPwd })
            });
            const data = await response.json();
            
            if(data.success) {
                btn.innerText = "Password Changed ‚úì";
                btn.style.background = "#16a34a";
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } else {
                alert(data.message);
                btn.innerText = "Update Password";
            }
        } catch(e) { alert("Error changing password"); }
        
        setTimeout(() => { btn.innerText = "Update Password"; btn.style.background = "#1e293b"; }, 3000);
    }

    let tempPhotoBase64 = null; 

    function previewPhoto(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function() {
            tempPhotoBase64 = reader.result; 
            const settingsImg = document.getElementById('settings-avatar-preview');
            if (settingsImg) settingsImg.src = tempPhotoBase64;
            document.getElementById('savePhotoBtn').style.display = 'block';
        }
        reader.readAsDataURL(file);
    }

    async function saveProfilePhoto() {
        if (!tempPhotoBase64) return;

        const btn = document.getElementById('savePhotoBtn');
        const originalText = btn.innerText;
        btn.innerText = "Updating...";

        try {
            const response = await fetch('/api/staff/update-photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: staffData.email, photoBase64: tempPhotoBase64 })
            });
            
            const data = await response.json();
            if(data.success) {
                staffData.profilePhoto = tempPhotoBase64;
                localStorage.setItem('staffData', JSON.stringify(staffData));

                if (document.getElementById('idCardPhoto')) document.getElementById('idCardPhoto').src = tempPhotoBase64;
                if (document.getElementById('settings-avatar-preview')) document.getElementById('settings-avatar-preview').src = tempPhotoBase64;
                if (document.getElementById('headerProfileImg')) document.getElementById('headerProfileImg').src = tempPhotoBase64;

                btn.innerText = "Updated ‚úì";
                btn.style.background = "#16a34a"; 
                
                setTimeout(() => {
                    btn.style.display = 'none';
                    btn.innerText = originalText;
                    btn.style.background = "#1e293b"; 
                }, 2000);
            } else {
                alert("Backend Error: " + data.message);
                btn.innerText = originalText;
            }
        } catch(e) { 
            alert("Server se connect nahi ho paya!"); 
            btn.innerText = originalText;
        }
    }
</script>
</body>
</html>